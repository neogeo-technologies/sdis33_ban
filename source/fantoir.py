# -*- coding: utf-8 -*-

WAY_NATURE_DICT = {
    "ACH": "ANCIEN CHEMIN",
    "AER": "AERODROME",
    "AERG": "AEROGARE",
    "AGL": "AGGLOMERATION",
    "AIRE": "AIRE",
    "ALL": "ALLEE",
    "ANGL": "ANGLE",
    "ARC": "ARCADE",
    "ART": "ANCIENNE ROUTE",
    "AUT": "AUTOROUTE",
    "AV": "AVENUE",
    "BASE": "BASE",
    "BD": "BOULEVARD",
    "BER": "BERGE",
    "BORD": "BORD",
    "BRE": "BARRIERE",
    "BRG": "BOURG",
    "BRTL": "BRETELLE",
    "BSN": "BASSIN",
    "CAE": "CARRIERA",
    "CALL": "CALLE,CALLADA",
    "CAMI": "CAMIN",
    "CAMP": "CAMP",
    "CAN": "CANAL",
    "CAR": "CARREFOUR",
    "CARE": "CARRIERE",
    "CASR": "CASERNE",
    "CC": "CHEMIN COMMUNAL",
    "CD": "CHEMIN DEPARTEMENTAL",
    "CF": "CHEMIN FORESTIER",
    "CHA": "CHASSE",
    "CHE": "CHEMIN",
    "CHEM": "CHEMINEMENT",
    "CHL": "CHALET",
    "CHP": "CHAMP",
    "CHS": "CHAUSSEE",
    "CHT": "CHATEAU",
    "CHV": "CHEMIN VICINAL",
    "CITE": "CITE",
    "CIVE": "COURSIVE",
    "CLOS": "CLOS",
    "CLR": "COULOIR",
    "COIN": "COIN",
    "COL": "COL",
    "COR": "CORNICHE",
    "CORO": "CORON",
    "COTE": "COTE",
    "COUR": "COUR",
    "CPG": "CAMPING",
    "CR": "CHEMIN RURAL",
    "CRS": "COURS",
    "CRX": "CROIX",
    "CTR": "CONTOUR",
    "CTRE": "CENTRE",
    "DARS": "DARSE,DARCE",
    "DEVI": "DEVIATION",
    "DIG": "DIGUE",
    "DOM": "DOMAINE",
    "DRA": "DRAILLE",
    "DSC": "DESCENTE",
    "ECA": "ECART",
    "ECL": "ECLUSE",
    "EMBR": "EMBRANCHEMENT",
    "EMP": "EMPLACEMENT",
    "ENC": "ENCLOS",
    "ENV": "ENCLAVE",
    "ESC": "ESCALIER",
    "ESP": "ESPLANADE",
    "ESPA": "ESPACE",
    "ETNG": "ETANG",
    "FD": "FOND",
    "FG": "FAUBOURG",
    "FON": "FONTAINE",
    "FOR": "FORET",
    "FORT": "FORT",
    "FOS": "FOSSE",
    "FRM": "FERME",
    "GAL": "GALERIE",
    "GARE": "GARE",
    "GBD": "GRAND BOULEVARD",
    "GPL": "GRANDE PLACE",
    "GR": "GRANDE RUE",
    "GREV": "GREVE",
    "HAB": "HABITATION",
    "HAM": "HAMEAU",
    "HIP": "HIPPODROME",
    "HLE": "HALLE",
    "HLG": "HALAGE",
    "HLM": "HLM",
    "HTR": "HAUTEUR",
    "ILE": "ILE",
    "ILOT": "ILOT",
    "IMP": "IMPASSE",
    "JARD": "JARDIN",
    "JTE": "JETEE",
    "LAC": "LAC",
    "LEVE": "LEVEE",
    "LICE": "LICES",
    "LIGN": "LIGNE",
    "LOT": "LOTISSEMENT",
    "MAIL": "MAIL",
    "MAIS": "MAISON",
    "MAR": "MARCHE",
    "MARE": "MARE",
    "MAS": "MAS",
    "MNE": "MORNE",
    "MRN": "MARINA",
    "MTE": "MONTEE",
    "NTE": "NOUVELLE ROUTE",
    "PAE": "PETITE AVENUE",
    "PARC": "PARC",
    "PAS": "PASSAGE",
    "PASS": "PASSE",
    "PCH": "PETIT CHEMIN",
    "PCHE": "PORCHE",
    "PHAR": "PHARE",
    "PIST": "PISTE",
    "PKG": "PARKING",
    "PL": "PLACE",
    "PLA": "PLACA",
    "PLAG": "PLAGE",
    "PLAN": "PLAN",
    "PLCI": "PLACIS",
    "PLE": "PASSERELLE",
    "PLN": "PLAINE",
    "PLT": "PLATEAU",
    "PNT": "POINTE",
    "PONT": "PONT",
    "PORQ": "PORTIQUE",
    "PORT": "PORT",
    "POST": "POSTE",
    "POT": "POTERNE",
    "PROM": "PROMENADE",
    "PRT": "PETITE ROUTE",
    "PRV": "PARVIS",
    "PTA": "PETITE ALLEE",
    "PTE": "PORTE",
    "PTR": "PETITE RUE",
    "PTTE": "PLACETTE",
    "QUA": "QUARTIER",
    "QUAI": "QUAI",
    "RAC": "RACCOURCI",
    "REM": "REMPART",
    "RES": "RESIDENCE",
    "RIVE": "RIVE",
    "RLE": "RUELLE",
    "ROC": "ROCADE",
    "RPE": "RAMPE",
    "RPT": "ROND-POINT",
    "RTD": "ROTONDE",
    "RTE": "ROUTE",
    "RUE": "RUE",
    "RUET": "RUETTE",
    "RUIS": "RUISSEAU",
    "RULT": "RUELLETTE",
    "RVE": "RAVINE",
    "SAS": "SAS",
    "SEN": "SENTIER,SENTE",
    "SQ": "SQUARE",
    "STDE": "STADE",
    "TER": "TERRE",
    "TOUR": "TOUR",
    "TPL": "TERRE-PLEIN",
    "TRA": "TRAVERSE",
    "TRAB": "TRABOULE",
    "TRN": "TERRAIN",
    "TRT": "TERTRE",
    "TSSE": "TERRASSE",
    "TUN": "TUNNEL",
    "VAL": "VAL",
    "VALL": "VALLON,VALLEE",
    "VC": "VOIE COMMUNALE",
    "VCHE": "VIEUX CHEMIN",
    "VEN": "VENELLE",
    "VGE": "VILLAGE",
    "VIA": "VIA",
    "VIAD": "VIADUC",
    "VIL": "VILLE",
    "VLA": "VILLA",
    "VOIE": "VOIE",
    "VOIR": "VOIRIE",
    "VOUT": "VOUTE",
    "VOY": "VOYEUL",
    "VTE": "VIEILLE ROUTE",
    "ZA": "ZA",
    "ZAC": "ZAC",
    "ZAD": "ZAD",
    "ZI": "ZI",
    "ZONE": "ZONE",
    "ZUP": "ZUP"
}


def is_way(fantoir_entry):
    """
    :param fantoir_entry: a line from a FANTOIR file
    :returns True or False regarding the entry concerns a way or not
    """
    result = False
    if len(fantoir_entry[48:49].strip()) != 0:
        result = True
    return result


def is_city(fantoir_entry):
    """
    :param fantoir_entry: a line from a FANTOIR file
    :returns True if the entry is a street
    """
    result = False
    if fantoir_entry[6:10].strip() == '' and fantoir_entry[10].strip() != '':
        result = True
    return result


def get_way_cat(way_cat_code):
    way_cat = None

    if way_cat_code >= '0' and way_cat_code <= '9':
        way_cat = u"voie"
    elif way_cat_code == 'A':
        way_cat = u"ensemble immobilier"
    elif way_cat_code >= 'B' and way_cat_code <= 'W':
        way_cat = u"lieu-dit"
    elif way_cat_code == 'X':
        way_cat = u"pseudo voie"
    elif way_cat_code >= 'Y' and way_cat_code <= 'Z':
        way_cat = u"voie provisoire"

    return way_cat


class FantoirParser(object):
    def __init__(self, fantoir_file_path):

        self.fantoir_file_path = fantoir_file_path
        self.cities = {}

        self.parse_file()

    def __str__(self):
        return self.fantoir_file_path

    def parse_file(self):
        fantoir_file = open(self.fantoir_file_path)
        city_name = None
        city_insee = None
        city_ways = None

        for line in fantoir_file.readlines():
            if is_city(line):
                city_name = line[11:41].strip()
                city_insee = line[0:2] + line[3:6]
                city_ways = []
                self.cities[city_insee] = {
                    "city_insee": city_insee,
                    "city_name": city_name,
                    "city_ways": city_ways
                }

            if is_way(line):
                way_name = line[15:41].strip()
                way_nature_code = line[11:15].strip()
                if len(way_nature_code) > 0 and way_nature_code in WAY_NATURE_DICT:
                    way_nature_labels = WAY_NATURE_DICT[way_nature_code].split(",")
                    complete_names = ["{} {}".format(nat, way_name) for nat in way_nature_labels]
                else:
                    complete_names = [way_name]
                way_cat_code = line[6:7]
                way_cat = get_way_cat(way_cat_code)
                city_ways.append({
                    "rivo": line[0:11],
                    "dept": line[0:2],
                    "comm": line[3:6],
                    "insee": city_insee,
                    "way": line[6:10],
                    "natu": way_nature_code,
                    "name": way_name,
                    "type": line[108:109],
                    "priv": line[48:49],
                    "cat_code":   way_cat_code,
                    "cat":        way_cat,
                    "comp_names": complete_names
                    # "full": line
                })

    def get_data_for_insee(self, insee):
        return self.cities[insee]

    def get_data(self):
        return self.cities
